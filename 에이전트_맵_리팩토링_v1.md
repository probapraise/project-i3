# 쇼츠 파이프라인 전체 구조 초안 v4

작성일: 2026-02-06

## 0) 최상위 목표 (North Star)
모든 의사결정은 아래 2개 목표를 최우선으로 둔다.

1. 스와이프 비율 최소화 (`Swipe Rate ↓`)
2. 시청 유지시간 최대화 (`Retention ↑`)

## 1) 핵심 원칙
- 원칙 A: 한 세션은 하나의 목적만 수행한다.
- 원칙 B: 창발(생성)과 검증(평가)을 분리한다.
- 원칙 C: 선택은 점수 계약(`Score Spec`) 기반으로 한다.
- 원칙 D: 세션 입출력 문서는 고정 스키마를 강제한다.
- 원칙 E: 스키마 검증 실패 시 즉시 중단한다(`Fail Closed`).
- 원칙 F: 초기 토픽 발굴은 사용자 수동 서치를 기본으로 한다.
- 원칙 G: 심플 이즈 베스트. 각 에이전트는 좁고 깊은 단일 목표만 수행한다.

## 2) 전체 파이프라인 구조
```text
[L0 Governance]
  RunOrchestrator
  ObjectiveGuard
  SchemaRegistry
  ContractValidator
  TelemetryLogger

[L1 Topic Research Session]
  TopicIngestor
  SearchAugmenter (Creator)
  SourceNormalizer
  ClaimVerifier (Evaluator)
  ResearchSelector (Selector)

[L2 Evidence Structuring Session]
  EvidenceStructurer (Creator)
  FactTagValidator (Evaluator)
  EvidenceSelector (Selector)

[L3 Inference Completion Session]
  InferenceFiller (Creator; NO_INFO only)
  InferenceReviewer (Evaluator)
  InferenceSelector (Selector)

[L4 Hook Session]
  HookIdeator (Creator)
  HookEvaluator (Evaluator)
  HookSelector (Selector + optional HITL)

[L5 Script Session]
  ScriptIdeator (Creator)
  ScriptEvaluator (Evaluator)
  ScriptSelector (Selector)
  TranslationWriter (Creator)
  TranslationCritic (Evaluator)
  TranslationReconstructor (Selector/HITL)
  NarrationExtractor

[L6 Scene Planning Session]
  StoryBibleBuilder (Creator)
  StoryBibleEvaluator (Evaluator)
  StoryBibleSelector (Selector)

  BeatSplitter (Creator)
  BeatEvaluator (Evaluator)
  BeatSelector (Selector)

  SceneComposer (Creator)
  SceneSplitCritic (Evaluator)
  SceneSplitSelector (Selector; resplit<=2)

  ScenesJSONBuilder(v2)

[L7 Scene Prompt Map Session]
  SceneContextPackager
  SceneBriefIdeator (Creator)
  SceneBriefEvaluator (Evaluator)
  SceneBriefSelector (Selector)
  VisualPromptIdeator (Creator)
  PromptEvaluator (Evaluator)
  PromptSelector (Selector)

[L8 Global Reduce Session]
  ContinuityAuditor (Evaluator)
  ConsistencyFixIdeator (Creator; flagged only)
  ConsistencyFixEvaluator (Evaluator)
  ConsistencyPatchSelector (Selector)

[L9 Production Session]
  ScriptParserAdapter
  ReferenceManager + CharacterTraitExtractor
  SketchGenerator
  ClipGenerator
  DubbingDirector
  SoundDirector
  PackageGeneratorAgent
```

## 3) L1~L3 신규 핵심 흐름 (요청사항 반영)

### 3.1 L1 Topic Research Session
목적:
- 사용자가 가져온 사건 토픽을 기반으로 자료를 최대한 보강한다.

입력:
- `topic_intake_input.json`
  - `topic_query`
  - `user_collected_materials` (메모/URL/이미지 설명/기사 조각)

처리:
1. `SearchAugmenter`: 사건 관련 자료를 추가 수집한다.
2. `SourceNormalizer`: 출처 메타데이터를 정규화한다.
3. `ClaimVerifier`: 핵심 claim의 검증 상태를 판정한다.
4. `ResearchSelector`: 다음 단계 전달본을 결정한다.

출력:
- `topic_research_bundle.json`
- `claim_verification_report.json`

### 3.2 L2 Evidence Structuring Session
목적:
- 씬 생성에 필요한 항목을 구조화하고, 자료 기반 여부를 태깅한다.

태그 규칙:
- `REAL`: 제출/조사 자료에 명시된 정보
- `NO_INFO`: 자료에 명시되지 않은 정보

처리:
1. `EvidenceStructurer`: 인물/장소/수법/현장/타임라인을 항목화한다.
2. `FactTagValidator`: `REAL/NO_INFO` 태그의 일관성을 검증한다.
3. `EvidenceSelector`: 구조화 결과를 확정한다.

출력:
- `entity_evidence_pack.json` (`REAL`, `NO_INFO`만 포함)

### 3.3 L3 Inference Completion Session
목적:
- `NO_INFO` 항목만 사건 맥락으로 추론 보강한다.

태그 규칙:
- `INFERRED`: 추론으로 채운 정보

처리:
1. `InferenceFiller`: `NO_INFO`만 채운다.
2. `InferenceReviewer`: 추론 품질/비약 여부를 검증한다.
3. `InferenceSelector`: 보강 결과를 확정한다.

출력:
- `entity_profile_pack.json` (`REAL + INFERRED + remaining NO_INFO`)

강제 규칙:
- `REAL`은 절대 덮어쓰지 않는다.
- `INFERRED`는 `reason`, `confidence`를 필수로 기록한다.
- 우선순위는 `REAL > INFERRED > NO_INFO`.

## 4) 씬 일관성에 중요한 항목과 생성 단계 분담

### 4.1 사건 보고서 점검 단계에서 생성/고정 (L2~L3)
- `character_id`
- `location_id`
- `prop_registry`
- `face_signature` (알려진 사실 중심)
- `body_signature` (알려진 사실 중심)
- `outfit_signature` (알려진 사실 중심)
- `risk/policy constraints`
- 각 필드의 `source_tag`, `confidence`, `reason`

### 4.2 비디오 프롬프팅 단계에서 생성 (L7)
- `shot_spec`
- `action_emotion`
- `time_weather`
- `continuity_state`
- `negative_constraints`
- 최종 `visual_prompt` (image/video)

### 4.3 하이브리드 항목
- `style_preset`
  - 채널 기본값은 고정
  - 씬별 미세 조정은 L7에서 수행
- `face/body/outfit`의 `NO_INFO`
  - L3에서 추론 채움
  - L7은 이를 참조해 연출 일관성만 조정

## 5) 핵심 문서 계약

### 5.1 `topic_intake_input.json`
- 사용자 수동 수집 토픽 입력

### 5.2 `topic_research_bundle.json`
- 검색 보강 결과 + 정규화 소스 목록

### 5.3 `entity_evidence_pack.json`
- 구조화 항목 + `REAL/NO_INFO` 태그

### 5.4 `entity_profile_pack.json`
- L3 추론 보강 결과 (`INFERRED` 포함)

### 5.5 `script_seed_pack.json`
- 훅/서사/트리거 워드/금지표현 시드

### 5.6 `scenes.json` v2
- downstream 허브 계약

## 6) 필드 단위 표준 구조
모든 장면 핵심 필드는 아래 형태를 따른다.

```json
{
  "field": "hair_color",
  "value": "black",
  "source_tag": "INFERRED",
  "confidence": 0.62,
  "reason": "사건 맥락 및 지역 일반 패턴 기반 추론",
  "sources": ["https://..."]
}
```

## 7) 세션 공통 입출력 포맷 (강제)
모든 세션은 아래 공통 문서를 사용한다.

- 입력: `session_input.json`
- 설정: `session_objective.json`
- 중간: `candidates_<task>.json`, `evaluation_report_<task>.json`
- 결과: `selection_trace_<task>.json`, `session_output.json`

공통 필수 필드:
- `schema_version`
- `session_id`
- `objective_id`
- `created_at`
- `input_artifact_refs`
- `output_artifact_refs`
- `status`

## 8) 문서 포맷 강제 체계

### 8.1 Schema Registry
- 경로: `schemas/*.schema.json`
- 역할: 세션별 입출력 스키마 SSOT

### 8.2 검증 게이트
- `Gate-In`: 세션 시작 전 입력 검증
- `Gate-Mid`: 후보/채점 문서 검증
- `Gate-Out`: 출력 검증 후 handoff

### 8.3 버전 정책
- 모든 문서는 `schema_version` 필수
- 하위 호환은 `minor` 범위만 허용
- `major` 변경 시 마이그레이션 단계 강제

## 9) 선택 품질 계약 (Score Spec)
- `score_spec_<task>.json`
- `evaluation_report_<task>.json`
- `selection_trace_<task>.json`

운영 규칙:
- `K1`(스와이프 억제), `K3`(리텐션) 가중치 우선
- `K5`(정책 안전) 하드 제약

## 10) 조사 에이전트 모델 운영 정책 (2026-02-06 기준)

### 10.1 운영 원칙
- 자동 `fallback/승격/재검색 루프`는 사용하지 않는다.
- 각 에이전트는 한 시점에 `단일 모델`만 사용한다.
- 결과 품질이 기준 미달이면 운영자가 모델을 `수동 교체`한 뒤 세션을 재실행한다.

### 10.2 L1 에이전트 모델 고정값 (v1)
- `SearchAugmenter`: `gpt-5.2 + web_search`
- `SourceNormalizer`: `gpt-5.2`
- `ClaimVerifier`: `gpt-5.2-pro`
- `ResearchSelector`: `gpt-5.2` (고정 `score_spec` 기준 선택)

주의:
- `Deep Research` 계열 모델은 기본 경로에 넣지 않는다.
- 필요 시 운영자가 `SearchAugmenter` 모델을 수동으로 교체해 단발성으로 사용한다.

### 10.3 수동 교체 운영 규칙
- 모델 변경 시점은 `세션 시작 전`으로 제한한다.
- 세션 도중 자동 모델 스위칭은 금지한다.
- 변경 이력은 `date`, `agent_id`, `from_model`, `to_model`, `reason`을 남긴다.
- 모델 변경 후에는 동일 `session_input`으로 재실행해 비교 가능성을 유지한다.

### 10.4 범용성 설계 원칙 (초기 설계 반영)
- 모델 선택 정보는 코드 하드코딩 대신 `agent_model_map` 설정 파일에서 읽는다.
- 에이전트 로직은 벤더 독립 인터페이스만 호출한다. (`search`, `generate`, `structured_output`)
- 벤더별 파라미터/SDK 차이는 Adapter 계층에서만 처리한다.
- 출력 계약은 모델과 무관하게 동일 스키마를 강제한다.
- 런타임 로그에 `provider`, `model`, `model_version`을 필수 기록한다.

## 11) 실패 처리
- 스키마 실패: 즉시 중단 + 원인 리포트
- 전 후보 하드탈락: Creator 재호출 1회
- 연속 실패: HITL 승격
- 세션 최대 재시도 초과 시 종료 및 로그 보존

## 12) 구현 시작 전 Freeze 목록
1. `topic_intake_input.json` 스키마
2. `topic_research_bundle.json` 스키마
3. `entity_evidence_pack.json` 스키마
4. `entity_profile_pack.json` 스키마
5. `source_tag` 규칙 (`REAL/INFERRED/NO_INFO`) 및 lock 정책
6. `score_spec_topic_intake.json` (검증률/시각자산/정책안전 가중치)
7. `score_spec_hook.json`
8. `score_spec_scene_split.json`
9. `score_spec_prompt.json`
10. `scenes.json v2` 필수/선택 필드 경계
11. `agent_model_map` 구조 (agent별 단일 모델 고정 + 수동 교체 이력 필드)
12. `inference_rules` 구조 (L3 추론 규칙 테이블 + 조건 키 표준)
13. `script_seed_pack.json` 스키마 및 필수 필드 경계
14. `script_session_pack.json` 스키마 및 필수 필드 경계
15. `score_spec_script.json`

## 13) 구현 착수용 파일 매핑 (현재 생성 완료)

### 13.0 Gate Validator 모듈
- `gate_validator.py`
- `examples/gate_in_manifest.sample.json`
- `examples/gate_out_manifest.sample.json`
- `README_gate_validator.md`

### 13.0.1 L1 실행 모듈
- `l1_topic_research_runner.py`
- `examples/artifacts/sample_session_objective.json`
- `README_l1_runner.md`

### 13.0.2 L2/L3 실행 모듈
- `l2_l3_profile_runner.py`
- `profile_lock_rules.py`
- `examples/artifacts/sample_session_input_l2.json`
- `examples/artifacts/sample_session_objective_l2_l3.json`
- `README_l2_l3_runner.md`

### 13.0.3 L4 실행 모듈
- `l4_hook_runner.py`
- `examples/artifacts/sample_session_input_l4.json`
- `examples/artifacts/sample_session_objective_l4_hook.json`
- `examples/artifacts/sample_entity_profile_pack.json`
- `README_l4_runner.md`

### 13.0.4 L5 실행 모듈
- `l5_script_session_runner.py`
- `examples/artifacts/sample_session_input_l5.json`
- `examples/artifacts/sample_session_objective_l5_script.json`
- `examples/artifacts/sample_script_seed_pack.json`
- `README_l5_runner.md`

### 13.0.5 L6 실행 모듈
- `l6_scene_planning_runner.py`
- `examples/artifacts/sample_session_input_l6.json`
- `examples/artifacts/sample_session_objective_l6_scene_plan.json`
- `examples/artifacts/sample_script_session_pack.json`
- `config/shorts.yaml`
- `README_l6_runner.md`

### 13.1 모델 설정
- `config/agent_model_map.yaml`

### 13.1.1 추론 규칙 설정
- `config/inference_rules.yaml` (L3 추론 규칙 테이블)

### 13.2 세션 공통 스키마
- `schemas/session_input.schema.json`
- `schemas/session_objective.schema.json`
- `schemas/session_output.schema.json`

### 13.3 핵심 아티팩트 스키마
- `schemas/topic_intake_input.schema.json`
- `schemas/topic_research_bundle.schema.json`
- `schemas/entity_evidence_pack.schema.json`
- `schemas/entity_profile_pack.schema.json`
- `schemas/script_seed_pack.schema.json`
- `schemas/script_session_pack.schema.json`
- `schemas/scenes_v2.schema.json`

### 13.4 점수 계약
- `score_specs/score_spec_topic_intake.json`
- `score_specs/score_spec_hook.json`
- `score_specs/score_spec_script.json`
- `score_specs/score_spec_scene_split.json`
- `score_specs/score_spec_prompt.json`

## 14) 구현 순서 (권장)
1. `Gate-In/Out` 검증 모듈에 `session_*` + 핵심 스키마 연결
2. L1 파이프라인에 `agent_model_map.yaml` 로딩 연결
3. `score_specs/*` 기반 `ResearchSelector` 계산 로직 구현
4. L2/L3에서 `REAL > INFERRED > NO_INFO` lock 규칙 적용
5. L5 Script Session 러너 구현 (Gate-In/Out + score spec + translation/narration 출력)
6. `scenes_v2` 생성기/검증기 연결 후 L7~L9 handoff 테스트
7. L7 Scene Prompt Map 세션 구현 (scene별 brief/prompt/validator + score_spec_prompt)
